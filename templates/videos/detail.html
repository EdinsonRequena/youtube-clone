{% extends "base.html" %}
{% block content %}

<a href="{% url 'home' %}" class="btn btn-outline-secondary btn-sm mb-3">&larr; Back</a>
<h2>{{ video.title }}</h2>

<iframe src="{{ video.embed_url }}" width="640" height="360" allowfullscreen class="mb-3"></iframe>

<div class="mb-3">
    <button id="like-btn" class="btn btn-sm me-2"
        data-active="{% if user_reaction == 'like' %}true{% else %}false{% endif %}">
        ğŸ‘ <span id="like-count">{{ likes }}</span>
    </button>

    <button id="dislike-btn" class="btn btn-sm"
        data-active="{% if user_reaction == 'dislike' %}true{% else %}false{% endif %}">
        ğŸ‘ <span id="dislike-count">{{ dislikes }}</span>
    </button>

</div>

<script>
    function applyStyles(btn) {
        if (btn.dataset.active === "true") {
            btn.classList.add("btn-success");
            btn.classList.remove("btn-outline-secondary");
        } else {
            btn.classList.add("btn-outline-secondary");
            btn.classList.remove("btn-success");
        }
    }
    applyStyles(document.getElementById("like-btn"));
    applyStyles(document.getElementById("dislike-btn"));

    function toggle(value) {
        fetch("{% url 'video-react' video.pk %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "value=" + value
        })
            .then(r => r.json())
            .then(data => {
                document.getElementById("like-count").textContent = data.likes;
                document.getElementById("dislike-count").textContent = data.dislikes;

                const likeBtn = document.getElementById("like-btn");
                const dislikeBtn = document.getElementById("dislike-btn");

                likeBtn.dataset.active = data.user_value === "like";
                dislikeBtn.dataset.active = data.user_value === "dislike";
                likeBtn.dataset.active === "true"
                    ? likeBtn.classList.replace("btn-outline-secondary", "btn-success")
                    : likeBtn.classList.replace("btn-success", "btn-outline-secondary");
                dislikeBtn.dataset.active === "true"
                    ? dislikeBtn.classList.replace("btn-outline-secondary", "btn-danger")
                    : dislikeBtn.classList.replace("btn-danger", "btn-outline-secondary");
            });
    }
    document.getElementById("like-btn").onclick = () => toggle("like");
    document.getElementById("dislike-btn").onclick = () => toggle("dislike");
</script>
{% endblock %}